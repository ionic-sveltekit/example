<script lang="ts" module>
  import { onMount } from "svelte";

  import { handleEnterKey } from "@ionic-sveltekit/components";
</script>

<script lang="ts">
  let spinCount = $state(0);
  let clickCount = $state(0);

  const rotate = $derived((spinCount + clickCount) * -22.5);
  const counterRotate = $derived(rotate * -2);

  const verb = $derived("click" + (clickCount === 1 ? "" : "s"));

  let isSpinEnabled = $state(false);

  function onclick() {
    isSpinEnabled = false;

    clickCount++;
  }

  function reset() {
    clickCount = 0;
  }

  function handleToggleChange(event: CustomEvent) {
    isSpinEnabled = event.detail?.checked ?? false;
  }

  let lastTimestamp: number = 0;

  let rafId: number = 0;

  function animationFrameCallback(timestamp: number) {
    if (timestamp - lastTimestamp < 225) {
      rafId = requestAnimationFrame(animationFrameCallback);

      return;
    }

    lastTimestamp = timestamp;

    if (isSpinEnabled) {
      spinCount++;
    }

    rafId = requestAnimationFrame(animationFrameCallback);
  }

  onMount(() => {
    rafId = requestAnimationFrame(animationFrameCallback);

    return () => cancelAnimationFrame(rafId);
  });
</script>

<ion-card>
  <svg
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 160 160"
    style={`transform: rotate(${rotate}deg);`}
  >
    <g fill="#176BFF">
      <path
        d="M19.2 80c0-33.579 27.221-60.8 60.8-60.8 13.517 0 25.997 4.404 36.095 11.868a22.918 22.918 0 0 1 14.557-12.992C116.863 6.786 99.218 0 80 0 35.817 0 0 35.817 0 80s35.817 80 80 80c44.182 0 80-35.817 80-80a79.896 79.896 0 0 0-4.47-26.423c-3.94 5.328-10.142 8.883-17.188 9.247A60.827 60.827 0 0 1 140.8 80c0 33.58-27.221 60.8-60.8 60.8-33.579 0-60.8-27.22-60.8-60.8Z"
      />
      <path
        d="M158.355 63.791a79.498 79.498 0 0 0-2.824-10.214c-3.941 5.328-10.143 8.883-17.189 9.247a60.512 60.512 0 0 1 2.24 11.988c7.42-.912 13.834-5.075 17.773-11.02ZM132.5 50c9.665 0 17.5-7.835 17.5-17.5S142.165 15 132.5 15 115 22.835 115 32.5 122.835 50 132.5 50Z"
      />
    </g>
    <g style={`transform: rotate(${counterRotate}deg);`}>
      <path
        fill="#ff3e00"
        d="M113.31 45.603c-8.666-12.483-25.919-16.14-38.323-8.269L53.122 51.328c-5.963 3.736-10.097 9.859-11.29 16.776-1.034 5.804-.159 11.767 2.624 16.935-1.908 2.863-3.181 6.043-3.737 9.383a26.75 26.75 0 0 0 4.532 20.195c8.746 12.483 25.92 16.14 38.323 8.269l21.865-13.914c5.963-3.737 10.098-9.859 11.29-16.777 1.034-5.804.159-11.767-2.623-16.935 1.908-2.862 3.18-6.043 3.736-9.382a26.196 26.196 0 0 0-4.532-20.275Z"
      />
      <path
        fill="#fff"
        d="M72.977 116.201a17.332 17.332 0 0 1-18.605-6.917c-2.544-3.499-3.498-7.872-2.783-12.165.16-.716.319-1.352.478-2.068l.397-1.272 1.113.795a28.982 28.982 0 0 0 8.587 4.294l.795.238-.079.795a5.317 5.317 0 0 0 .874 3.26c1.273 1.829 3.499 2.704 5.646 2.147.477-.159.954-.318 1.351-.556l21.786-13.914c1.113-.716 1.828-1.75 2.067-3.022.238-1.272-.08-2.624-.795-3.657-1.272-1.829-3.499-2.624-5.645-2.067-.477.159-.954.318-1.352.556l-8.348 5.327a14.775 14.775 0 0 1-4.453 1.908 17.33 17.33 0 0 1-18.605-6.917c-2.465-3.498-3.498-7.871-2.703-12.165.715-4.134 3.259-7.871 6.838-10.097L81.405 46.79c1.352-.875 2.863-1.511 4.453-1.988a17.33 17.33 0 0 1 18.605 6.917c2.544 3.498 3.498 7.871 2.783 12.165a19.79 19.79 0 0 1-.557 2.067l-.397 1.272-1.113-.795a29.016 29.016 0 0 0-8.587-4.293l-.796-.239.08-.795a5.32 5.32 0 0 0-.875-3.26c-1.272-1.828-3.498-2.624-5.645-2.067-.477.159-.954.318-1.351.557L66.219 70.245c-1.113.715-1.828 1.749-2.067 3.021-.239 1.272.08 2.624.795 3.657 1.272 1.829 3.498 2.624 5.645 2.068.477-.159.954-.318 1.352-.557l8.348-5.327c1.352-.875 2.863-1.511 4.453-1.988a17.331 17.331 0 0 1 18.605 6.918c2.544 3.498 3.498 7.871 2.783 12.164-.716 4.135-3.26 7.872-6.838 10.098L77.43 114.213c-1.352.875-2.862 1.511-4.453 1.988Z"
      />
    </g>
  </svg>

  <ion-card-header>
    <ion-card-title>Homepage</ion-card-title>

    <ion-card-subtitle>Welcome</ion-card-subtitle>
  </ion-card-header>

  <ion-card-content>
    <ion-list>
      <ion-item>
        <ion-toggle checked={isSpinEnabled} onionChange={handleToggleChange}
          >spin</ion-toggle
        >
      </ion-item>

      <ion-item href="/planets">
        <ion-label>learn about our planets</ion-label>
      </ion-item>

      <ion-list-header>
        <ion-label>Or enjoy some mindless clicking</ion-label>
      </ion-list-header>

      <ion-item lines="none">
        <ion-button
          {onclick}
          onkeydown={handleEnterKey(onclick)}
          role="button"
          tabindex="0"
          size="default"
          fill="outline"
        >
          {clickCount}
          {verb}
        </ion-button>

        <ion-button
          slot="end"
          onclick={reset}
          onkeydown={handleEnterKey(reset)}
          role="button"
          tabindex="0"
          size="small"
          fill="clear"
          disabled={clickCount === 0}
        >
          reset clicks
        </ion-button>
      </ion-item>
    </ion-list>
  </ion-card-content>
</ion-card>

<style>
  svg {
    margin: 1.5em;
  }

  svg,
  svg g:last-child {
    transform-origin: center;
    transition: transform 250ms linear;
  }
</style>
